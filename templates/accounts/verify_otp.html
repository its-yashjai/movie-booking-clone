{% extends 'base/base.html' %}

{% block title %}Verify Email - BookMyshowClone{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow-lg border-0" style="border-top: 4px solid #28a745;">
                <div class="card-body p-5">
                    <!-- Header -->
                    <div class="text-center mb-5">
                        <div class="mb-3">
                            <i class="fas fa-envelope-open-text text-success" style="font-size: 4rem;"></i>
                        </div>
                        <h1 class="h2 mb-2">
                            <i class="fas fa-shield-alt text-success"></i> Verify Your Email
                        </h1>
                        {% if pending_user.email %}
                        <p class="text-muted">Enter the 6-digit OTP sent to</p>
                        <p class="fw-bold text-primary">{{ pending_user.email }}</p>
                        {% else %}
                        <p class="text-muted">Enter the 6-digit OTP sent to your email</p>
                        {% endif %}
                        <p class="text-danger small">‚è∞ OTP expires in 5 minutes</p>
                    </div>
                    
                    <!-- OTP Verification Form -->
                    <form method="POST" class="needs-validation" id="otpForm">
                        {% csrf_token %}
                        
                        <!-- OTP Field -->
                        <div class="mb-4">
                            <label for="otp" class="form-label fw-600">
                                <i class="fas fa-key me-2"></i>Verification Code
                            </label>
                            <input type="text" name="otp" class="form-control form-control-lg text-center" 
                                   id="otp" placeholder="000000" maxlength="6" pattern="[0-9]{6}" required
                                   style="letter-spacing: 10px; font-size: 1.5rem; font-weight: bold;" autofocus>
                            <small class="form-text text-muted d-block mt-2">
                                Enter the 6-digit code from your email
                            </small>
                        </div>
                        
                        <!-- Submit Button -->
                        <button type="submit" class="btn btn-success btn-lg w-100 mb-3 fw-600" id="verifyBtn">
                            <span class="btn-text">
                                <i class="fas fa-check-circle me-2"></i>Verify Email
                            </span>
                            <span class="btn-loading" style="display: none;">
                                <i class="fas fa-spinner fa-spin me-2"></i>Verifying...
                            </span>
                        </button>
                    </form>
                    
                    <hr>
                    
                    <!-- Footer Links -->
                    <div class="text-center">
                        <p class="text-muted mb-2">
                            Didn't receive the code?
                        </p>
                        <a href="{% url 'resend_verification' %}" class="btn btn-outline-primary btn-sm" id="resendBtn">
                            <span class="btn-text">
                                <i class="fas fa-redo me-1"></i>Resend OTP
                            </span>
                            <span class="btn-loading" style="display: none;">
                                <i class="fas fa-spinner fa-spin me-1"></i>Sending...
                            </span>
                        </a>
                    </div>
                    
                    <div class="text-center mt-3">
                        <p class="text-muted small">
                            <a href="{% url 'login' %}" class="text-decoration-none">
                                <i class="fas fa-arrow-left me-1"></i>Back to Login
                            </a>
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Help Text -->
            <div class="alert alert-info mt-4" role="alert">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Instructions:</strong>
                <ul class="mb-0 mt-2">
                    <li>Check your email inbox for the verification code</li>
                    <li>The code is 6 digits long</li>
                    <li>The code expires in 5 minutes</li>
                    <li>If you don't see the email, check your spam folder</li>
                    <li>You can request a new code if needed</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<style>
    .form-control-lg {
        height: 60px;
        font-size: 1.2rem;
        border-radius: 8px;
        border: 2px solid #dee2e6;
        transition: all 0.3s ease;
    }
    
    .form-control-lg:focus {
        border-color: #28a745;
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
    }
    
    .btn-lg {
        height: 50px;
        font-size: 1rem;
        border-radius: 8px;
    }
    
    .card {
        border-radius: 12px;
    }
    
    .alert {
        border-radius: 8px;
        border-left: 4px solid #17a2b8;
    }
    
    .alert ul li {
        margin-bottom: 0.25rem;
    }
    
    /* OTP Input Styling */
    input#otp {
        font-family: 'Courier New', monospace;
    }
    
    .btn-loading-state {
        opacity: 0.8;
        cursor: not-allowed !important;
    }
</style>

<script>
    // Auto-focus on OTP field and format input
    document.addEventListener('DOMContentLoaded', function() {
        const otpInput = document.getElementById('otp');
        const form = document.getElementById('otpForm');
        const verifyBtn = document.getElementById('verifyBtn');
        const resendBtn = document.getElementById('resendBtn');
        
        // Loading state functions
        function showLoading(btn) {
            const btnText = btn.querySelector('.btn-text');
            const btnLoading = btn.querySelector('.btn-loading');
            if (btnText && btnLoading) {
                btnText.style.display = 'none';
                btnLoading.style.display = 'inline-block';
                btn.disabled = true;
                btn.classList.add('btn-loading-state');
            }
        }
        
        function hideLoading(btn) {
            const btnText = btn.querySelector('.btn-text');
            const btnLoading = btn.querySelector('.btn-loading');
            if (btnText && btnLoading) {
                btnText.style.display = 'inline-block';
                btnLoading.style.display = 'none';
                btn.disabled = false;
                btn.classList.remove('btn-loading-state');
            }
        }
        
        // Form submit loading
        form.addEventListener('submit', function(e) {
            if (otpInput.value.length !== 6) {
                e.preventDefault();
                alert('Please enter a 6-digit OTP');
                return;
            }
            
            showLoading(verifyBtn);
            
            // Timeout to prevent indefinite loading
            setTimeout(() => {
                hideLoading(verifyBtn);
            }, 10000);
        });
        
        // Resend button loading
        if (resendBtn) {
            resendBtn.addEventListener('click', function(e) {
                showLoading(resendBtn);
                
                // Timeout for resend
                setTimeout(() => {
                    hideLoading(resendBtn);
                }, 8000);
            });
        }
        
        // Only allow numbers
        otpInput.addEventListener('input', function(e) {
            this.value = this.value.replace(/[^0-9]/g, '');
            
            // Auto-submit when 6 digits are entered (optional)
            if (this.value.length === 6) {
                // Uncomment next line for auto-submit
                // this.form.submit();
            }
        });
        
        // Paste handling - extract only numbers
        otpInput.addEventListener('paste', function(e) {
            e.preventDefault();
            const paste = (e.clipboardData || window.clipboardData).getData('text');
            const numbers = paste.replace(/[^0-9]/g, '').substring(0, 6);
            this.value = numbers;
        });
    });
</script>
{% endblock %}
